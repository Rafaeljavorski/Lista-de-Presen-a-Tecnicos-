<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5a4">
  <title>Lista Diária — Técnicos (Dark Mobile App)</title>
  <style>
    :root{
      --bg:#0f172a;--card:#0b1220;--muted:#9aa4b2;--accent:#0ea5a4;--danger:#ef4444;--ok:#10b981;
      --surface:#071028; --text:#e6eef6; --muted-2:#94a3b8;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
    .app{max-width:980px;margin:0 auto;padding:12px 12px 80px;box-sizing:border-box;}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(2,6,23,0.6),transparent);backdrop-filter: blur(6px);z-index:40;padding:8px 0;display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0;color:var(--text)}
    p.small{margin:0;color:var(--muted-2);font-size:13px}
    .controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;align-items:center}
    input[type=date]{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    button{padding:10px 12px;border-radius:12px;border:0;background:var(--accent);color:#001219;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:12px;box-shadow: 0 6px 18px rgba(0,0,0,0.6);margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center}
    .sup-title{font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .legend{display:flex;gap:8px;align-items:center;margin-left:16px}
    .pill{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);font-weight:700;font-size:13px;color:var(--muted-2)}
    .pill.trab{background:linear-gradient(90deg, rgba(16,185,129,0.14), rgba(16,185,129,0.06));color:var(--ok);border-color:rgba(16,185,129,0.22)}
    .pill.nao{background:linear-gradient(90deg, rgba(239,68,68,0.14), rgba(239,68,68,0.06));color:var(--danger);border-color:rgba(239,68,68,0.22)}
    .tech{border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));}
    .tech .name{font-weight:800;color:var(--text);font-size:15px}
    .buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .btn-status{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;font-weight:800;color:var(--text);min-height:44px;display:inline-flex;align-items:center;justify-content:center;font-size:13px}
    .btn-trabalha{ border-color: rgba(16,185,129,0.22); color: var(--ok); background: linear-gradient(90deg, rgba(16,185,129,0.06), rgba(16,185,129,0.02)); }
    .btn-nao{ border-color: rgba(239,68,68,0.22); color: var(--danger); background: linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02)); }
    .btn-entra{ border-color: rgba(245,158,11,0.22); color: #f59e0b; background: linear-gradient(90deg, rgba(245,158,11,0.06), rgba(245,158,11,0.02)); }
    .btn-sai{ border-color: rgba(249,115,22,0.22); color: #f97316; background: linear-gradient(90deg, rgba(249,115,22,0.06), rgba(249,115,22,0.02)); }
    .btn-trabalha.active{ background: var(--ok); color: #002; border-color: var(--ok); }
    .btn-nao.active{ background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn-entra.active{ background: #f59e0b; color: #fff; border-color:#f59e0b }
    .btn-sai.active{ background: #f97316; color: #fff; border-color:#f97316 }
    input[type=time], input[type=text]{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);width:100%}
    textarea{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .flex{display:flex;gap:8px}
    .chart{height:34px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));position:relative;margin-top:8px;overflow:hidden}
    .chart .active{height:100%;background:linear-gradient(90deg,#10b981,#059669);border-radius:8px 0 0 8px}
    .chart .inactive{height:100%;background:linear-gradient(90deg,#f97316,#fb923c);position:absolute;right:0;top:0;border-radius:0 8px 8px 0}
    .small-muted{font-size:12px;color:var(--muted-2)}
    .filterBar button{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;font-weight:800}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:12px;z-index:60}
    .modal{background:var(--card);border-radius:12px;width:100%;max-width:520px;padding:16px;box-shadow:0 12px 40px rgba(2,6,23,0.6)}
    .list-select{max-height:260px;overflow:auto;border:1px solid rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-bottom:8px;background:transparent}
    .list-item{padding:8px;border-radius:8px;border:1px solid transparent;margin-bottom:6px;color:var(--text)}
    .admin-badge{background:var(--accent);color:#001219;padding:6px 10px;border-radius:999px;font-weight:800}
    .top-actions{display:flex;gap:8px;align-items:center;margin-left:auto}
    .theme-toggle{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:var(--text);font-weight:800}
    /* Mobile app layout */
    @media (max-width:600px){
      .app{padding:10px 10px 110px}
      header{padding:10px}
      .controls{gap:6px}
      .buttons{grid-template-columns:repeat(2,1fr);gap:6px}
      .btn-status{min-height:48px;padding:12px;font-size:14px}
      .card{padding:10px;border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Lista Diária — Técnicos</h1>
        <p class="small">Visual móvel + tema escuro • Atualiza em tempo real</p>
      </div>
      <div class="top-actions">
        <button id="fullscreenBtn" class="theme-toggle">Abrir App</button>
        <button id="themeBtn" class="theme-toggle">Tema claro</button>
        <div id="adminIndicator" style="display:none" class="admin-badge">ADMIN</div>
        <button id="adminToggle" class="ghost">Entrar Admin</button>
      </div>
    </header>

    <div class="controls">
      <input id="date" type="date" />
      <button id="csvBtn" class="ghost">Exportar CSV</button>
      <button id="resetBtn" class="ghost">Resetar</button>
      <button id="openAdd" class="ghost" title="Adicionar técnico (requer admin)">Adicionar</button>
      <button id="openRemove" class="ghost" title="Excluir técnico (requer admin)">Excluir</button>
      <button id="openMove" class="ghost" title="Mover técnico (requer admin)">Mover</button>
    </div>

    <div id="filterBar" class="controls filterBar" style="margin-bottom:8px"></div>

    <div class="card" id="overview">
      <div class="row">
        <div>
          <div class="small-muted">Técnicos totais</div>
          <div id="total" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div style="margin-left:16px">
          <div class="small-muted">Ativos</div>
          <div id="active" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div style="margin-left:16px">
          <div class="small-muted">Não ativos</div>
          <div id="inactive" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div class="small-muted">Ativos %</div>
          <div id="pct" style="font-weight:800;font-size:20px">0%</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;margin-top:10px">
        <div class="legend">
          <div class="pill trab">Trabalha</div>
          <div class="pill nao">Não</div>
          <div class="pill entra">Entra mais tarde</div>
          <div class="pill sai">Sai mais cedo</div>
        </div>
      </div>
      <div class="chart" aria-hidden>
        <div id="chartActive" class="active" style="width:0%"></div>
        <div id="chartInactive" class="inactive" style="width:0%"></div>
      </div>
    </div>

    <div id="supervisors"></div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" id="modal">
      <h3 id="modalTitle">Modal</h3>
      <div id="modalBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="ghost">Cancelar</button>
        <button id="modalConfirm">Confirmar</button>
      </div>
    </div>
  </div>

<script>
/* === FIREBASE CONFIG === Replace with your config */
const FIREBASE_CONFIG = {
  apiKey: "FIREBASE_API_KEY",
  authDomain: "PROJECT_ID.firebaseapp.com",
  databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
const ADMIN_PASSWORD = 'admin123';
const DATA_NODE = 'presenca_v1';
const HISTORY_NODE = 'history_v1';

/* Supervisor display titles (adjusted) */
const SUP_TITLES = {
  Lucas: "Lista 1 — Lucas",
  Israel: "Lista 2 — Israel",
  Litoral: "Lista 3 — Litoral"
};

// init firebase
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
const dbRef = db.ref(DATA_NODE);

// DOM refs
const dateInput = document.getElementById('date');
const supervisorsDiv = document.getElementById('supervisors');
const csvBtn = document.getElementById('csvBtn');
const resetBtn = document.getElementById('resetBtn');
const openAdd = document.getElementById('openAdd');
const openRemove = document.getElementById('openRemove');
const openMove = document.getElementById('openMove');
const filterBar = document.getElementById('filterBar');
const totalEl = document.getElementById('total');
const activeEl = document.getElementById('active');
const inactiveEl = document.getElementById('inactive');
const pctEl = document.getElementById('pct');
const chartActive = document.getElementById('chartActive');
const chartInactive = document.getElementById('chartInactive');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');
const adminToggle = document.getElementById('adminToggle');
const adminIndicator = document.getElementById('adminIndicator');
const markAllActiveBtn = document.getElementById('markAllActiveBtn');
const saveDayBtn = document.getElementById('saveDayBtn');
const viewMonthBtn = document.getElementById('viewMonthBtn');
const themeBtn = document.getElementById('themeBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');

// state
let DATA = {};
let isAdmin = false;
let currentFilter = null;

// date default
function todayISO(){ return (new Date()).toISOString().slice(0,10); }
dateInput.value = todayISO();

// build filter buttons
function buildFilterButtons(){
  filterBar.innerHTML = '';
  const btnAll = document.createElement('button'); btnAll.textContent='Todos'; btnAll.className='ghost';
  btnAll.onclick = ()=>{ currentFilter = null; render(); };
  filterBar.appendChild(btnAll);
  Object.keys(SUP_TITLES).forEach(s=>{ const b=document.createElement('button'); b.textContent = SUP_TITLES[s] || s; b.className='ghost'; b.onclick = ()=>{ currentFilter=(currentFilter===s?null:s); render(); }; filterBar.appendChild(b); });
}
buildFilterButtons();

// ---------- Firebase sync (normalize keys) ----------
dbRef.once('value', snap=>{
  if(!snap.exists()){
    // seed DB from INITIAL (not included here to avoid duplication; assume exists)
    // If DB empty, create placeholder structure
    const seed = {};
    Object.keys(SUP_TITLES).forEach(s=> seed[s] = []);
    dbRef.set(seed);
  }
});

dbRef.on('value', snap => {
  const raw = snap.val() || {};
  const normalized = {};
  Object.keys(raw).forEach(k => {
    let decoded;
    try { decoded = decodeURIComponent(k); } catch(e) { decoded = k; }
    const arr = raw[k] || [];
    normalized[decoded] = (Array.isArray(arr) ? arr : Object.values(arr)).map(item => {
      if(!item) return { name:'(sem nome)', status:'pendente', time:'', note:'' };
      if(typeof item === 'string') return { name: item, status:'pendente', time:'', note:'' };
      // strip "CIP _ " prefix for display only
      const displayName = (item.name || '').replace(/^CIP\s*_+\s*/i, '').trim() || '(sem nome)';
      return {
        name: displayName,
        __fullName: item.name || displayName, // keep original full name for exports
        status: item.status || 'pendente',
        time: item.time || '',
        note: item.note || ''
      };
    });
  });
  DATA = normalized;
  render();
});

// per-path write helpers
function writeStatusToFirebase(supervisor, idx, status){
  const supKey = encodeURIComponent(supervisor);
  const path = DATA_NODE + '/' + supKey + '/' + idx + '/status';
  db.ref(path).set(status).catch(err=>console.error('writeStatus error',err));
}
function writeFieldToFirebase(supervisor, idx, field, value){
  const supKey = encodeURIComponent(supervisor);
  const path = DATA_NODE + '/' + supKey + '/' + idx + '/' + field;
  db.ref(path).set(value).catch(err=>console.error('writeField error',err));
}

// render
function render(){
  supervisorsDiv.innerHTML='';

  // totals
  let total=0, active=0, inactive=0;
  Object.keys(DATA).forEach(s=>{
    if(currentFilter && currentFilter !== s) return;
    const list = DATA[s] || [];
    list.forEach(t=>{ total++; if(t.status==='nao' || t.status==='pendente') inactive++; else active++; });
  });
  totalEl.textContent = String(total);
  activeEl.textContent = String(active);
  inactiveEl.textContent = String(inactive);
  const pct = total ? Math.round((active/total)*100) : 0;
  pctEl.textContent = pct + '%';
  chartActive.style.width = pct + '%';
  chartInactive.style.width = (100 - pct) + '%';

  Array.from(filterBar.children).forEach(b => b.classList.toggle('filter-active', (SUP_TITLES[b.textContent] ? SUP_TITLES[b.textContent] : b.textContent) === (currentFilter ? SUP_TITLES[currentFilter] : null)));

  Object.keys(DATA).filter(s=>!currentFilter||currentFilter===s).forEach(s=>{
    const supList = DATA[s] || [];
    const supTotal = supList.length;
    const supActive = supList.reduce((acc,t)=> acc + ((t.status && t.status!=='nao' && t.status!=='pendente')?1:0), 0);
    const supPct = supTotal ? Math.round((supActive/supTotal)*100) : 0;

    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('div'); title.className='sup-title';
    const titleText = document.createElement('div'); titleText.textContent = SUP_TITLES[s] || s; title.appendChild(titleText);
    const pctSmall = document.createElement('div'); pctSmall.className='small-muted'; pctSmall.style.marginLeft='auto';
    pctSmall.textContent = supActive + '/' + supTotal + ' • ' + supPct + '%'; title.appendChild(pctSmall);

    const miniChart = document.createElement('div'); miniChart.className='chart'; miniChart.style.height='12px'; miniChart.style.marginTop='6px';
    const a = document.createElement('div'); a.className='active'; a.style.width = supPct + '%'; a.style.height='100%';
    const i = document.createElement('div'); i.className='inactive'; i.style.width = (100 - supPct) + '%'; i.style.height='100%';
    miniChart.appendChild(a); miniChart.appendChild(i);

    card.appendChild(title); card.appendChild(miniChart);

    supList.forEach((t, idx)=>{
      const box = document.createElement('div'); box.className='tech';
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div'); left.style.flex='1';
      const nm = document.createElement('div'); nm.className='name'; nm.textContent = t.name || '(sem nome)'; left.appendChild(nm);
      const noteSmall = document.createElement('div'); noteSmall.className='small-muted'; noteSmall.textContent = t.note || ''; left.appendChild(noteSmall);
      row.appendChild(left);

      const right = document.createElement('div'); right.style.width='120px'; right.style.textAlign='right';
      const moveBtn = document.createElement('button'); moveBtn.className='ghost'; moveBtn.textContent='Mover';
      moveBtn.title = 'Mover técnico (requer admin)';
      moveBtn.onclick = ()=> { requireAdmin(()=> openMoveModal(s, idx)); };
      right.appendChild(moveBtn); row.appendChild(right); box.appendChild(row);

      const btns = document.createElement('div'); btns.className='buttons';
      const bTr = makeBtn('Trabalha','trabalha', t.status === 'trabalha');
      const bNa = makeBtn('Não Trabalha','nao', t.status === 'nao');
      const bEn = makeBtn('Entra mais tarde','entra_mais_tarde', t.status === 'entra_mais_tarde');
      const bSa = makeBtn('Sai mais cedo','sai_mais_cedo', t.status === 'sai_mais_cedo');

      bTr.onclick = ()=> { setStatus(s, idx, 'trabalha'); };
      bNa.onclick = ()=> { setStatus(s, idx, 'nao'); };
      bEn.onclick = ()=> { setStatus(s, idx, 'entra_mais_tarde'); };
      bSa.onclick = ()=> { setStatus(s, idx, 'sai_mais_cedo'); };

      btns.appendChild(bTr); btns.appendChild(bNa); btns.appendChild(bEn); btns.appendChild(bSa);
      box.appendChild(btns);

      if(t.status === 'entra_mais_tarde' || t.status === 'sai_mais_cedo'){
        const flex = document.createElement('div'); flex.className='flex'; flex.style.marginTop='8px';
        const time = document.createElement('input'); time.type='time'; time.value = t.time || '';
        time.onchange = (e)=> { t.time = e.target.value; writeFieldToFirebase(s, idx, 'time', e.target.value); };
        flex.appendChild(time); box.appendChild(flex);
      }

      const note = document.createElement('textarea'); note.placeholder='Observação / motivo'; note.value = t.note || '';
      note.onchange = (e)=> { t.note = e.target.value; writeFieldToFirebase(s, idx, 'note', e.target.value); };
      note.style.marginTop='8px'; box.appendChild(note);

      card.appendChild(box);
    });

    supervisorsDiv.appendChild(card);
  });
}

// makeBtn
function makeBtn(label, status, active){
  const b = document.createElement('button');
  b.className = 'btn-status';
  b.textContent = label;
  if(status === 'trabalha') b.classList.add('btn-trabalha');
  if(status === 'nao') b.classList.add('btn-nao');
  if(status === 'entra_mais_tarde') b.classList.add('btn-entra');
  if(status === 'sai_mais_cedo') b.classList.add('btn-sai');
  if(active) b.classList.add('active');
  return b;
}

// setStatus
function setStatus(s, idx, status){
  if(!DATA[s] || !DATA[s][idx]) return;
  DATA[s][idx].status = status;
  if(status !== 'entra_mais_tarde' && status !== 'sai_mais_cedo') {
    DATA[s][idx].time = '';
    writeFieldToFirebase(s, idx, 'time', '');
  }
  writeStatusToFirebase(s, idx, status);
}

// CSV export (uses __fullName if present)
function exportCSV(){
  const rows = [['Date','Supervisor','Technician','Status','TimeAdjustment','Note']];
  const date = dateInput.value;
  Object.keys(DATA).forEach(s=>{ (DATA[s]||[]).forEach(t => rows.push([date,s,t.__fullName || t.name,t.status,t.time||'',t.note||''])); });
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'presenca_' + date + '.csv'; a.click(); URL.revokeObjectURL(url);
}
csvBtn.addEventListener('click', exportCSV);

// reset (admin)
resetBtn.addEventListener('click', ()=>{
  requireAdmin(()=>{
    const seed = {};
    Object.keys(SUP_TITLES).forEach(s=> seed[s] = []);
    dbRef.set(seed);
  });
});

// modal helpers
function openModal(title, bodyNode, confirmLabel='Confirmar', onConfirm){
  modalTitle.textContent = title; modalBody.innerHTML = ''; modalBody.appendChild(bodyNode);
  modalBackdrop.style.display = 'flex'; modalBackdrop.setAttribute('aria-hidden','false'); modalConfirm.textContent = confirmLabel;
  function cleanup(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); modalConfirm.onclick = null; modalCancel.onclick = null; }
  modalCancel.onclick = ()=> { cleanup(); };
  modalConfirm.onclick = ()=> { try{ onConfirm(); } finally { cleanup(); } };
}

// admin
function requireAdmin(onSuccess){
  if(isAdmin){ onSuccess(); return; }
  const body = document.createElement('div');
  const inp = document.createElement('input'); inp.type='password'; inp.placeholder='Senha de administrador'; inp.style.width='100%'; inp.style.padding='8px';
  body.appendChild(inp);
  openModal('Acesso administrador', body, 'Entrar', ()=>{
    if(inp.value === ADMIN_PASSWORD){ isAdmin = true; adminIndicator.style.display='inline-block'; adminToggle.textContent='Bloquear Admin'; onSuccess(); }
    else { alert('Senha incorreta'); }
  });
}
adminToggle.onclick = ()=>{ if(isAdmin){ isAdmin=false; adminIndicator.style.display='none'; adminToggle.textContent='Entrar Admin'; } else { requireAdmin(()=>{}); } };

// Add / Remove / Move (uses supervisor-level writes for lists)
openAdd.onclick = ()=>{ requireAdmin(()=> openAddModal()); };
function openAddModal(){
  const body = document.createElement('div');
  const supSel = document.createElement('select'); supSel.style.width='100%'; supSel.style.padding='8px'; supSel.style.marginBottom='8px';
  Object.keys(SUP_TITLES).forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=SUP_TITLES[s] || s; supSel.appendChild(opt); });
  const nameInp = document.createElement('input'); nameInp.placeholder='Nome do técnico (com "CIP _ ...")'; nameInp.style.width='100%'; nameInp.style.padding='8px';
  body.appendChild(supSel); body.appendChild(nameInp);
  openModal('Adicionar Técnico', body, 'Adicionar', ()=>{
    const sup=supSel.value; const name = nameInp.value && nameInp.value.trim();
    if(!name) return alert('Informe um nome válido.');
    if(!DATA[sup]) DATA[sup] = [];
    DATA[sup].push({ name, status:'pendente', time:'', note:'' });
    const supPath = DATA_NODE + '/' + encodeURIComponent(sup);
    db.ref(supPath).set(DATA[sup]).catch(err=>console.error('add error',err));
  });
}

openRemove.onclick = ()=>{ requireAdmin(()=> openRemoveModal()); };
function openRemoveModal(){
  const body = document.createElement('div');
  const supSel = document.createElement('select'); supSel.style.width='100%'; supSel.style.padding='8px'; supSel.style.marginBottom='8px';
  Object.keys(SUP_TITLES).forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=SUP_TITLES[s] || s; supSel.appendChild(opt); });
  const listDiv = document.createElement('div'); listDiv.className='list-select';
  function refreshList(){ listDiv.innerHTML = ''; const arr = DATA[supSel.value] || []; if(arr.length===0){ listDiv.textContent='Sem técnicos.'; return; } arr.forEach((t,i)=>{ const el=document.createElement('div'); el.className='list-item'; el.textContent=(i+1)+' — '+t.name; el.dataset.idx=i; el.onclick=()=>{ Array.from(listDiv.children).forEach(c=>c.style.background=''); el.style.background='rgba(255,255,255,0.02)'; listDiv.dataset.chosenIdx=i; }; listDiv.appendChild(el); }); }
  supSel.onchange = refreshList; refreshList();
  body.appendChild(supSel); body.appendChild(listDiv);
  openModal('Excluir Técnico', body, 'Excluir', ()=>{ const idx=parseInt(listDiv.dataset.chosenIdx,10); if(Number.isNaN(idx)) return alert('Escolha um técnico.'); DATA[supSel.value].splice(idx,1); const supPath = DATA_NODE + '/' + encodeURIComponent(supSel.value); db.ref(supPath).set(DATA[supSel.value]); });
}

function openMoveModal(fromSup, idx){
  const body = document.createElement('div');
  const info = document.createElement('div'); info.className='small-muted'; info.style.marginBottom='8px';
  info.textContent = 'Mover: ' + (DATA[fromSup][idx]?.name || '(sem nome)') + ' — de ' + fromSup;
  const toSel = document.createElement('select'); toSel.style.width='100%'; toSel.style.padding='8px'; toSel.style.marginBottom='8px';
  Object.keys(SUP_TITLES).forEach(s=>{ if(s===fromSup) return; const opt=document.createElement('option'); opt.value=s; opt.textContent=SUP_TITLES[s] || s; toSel.appendChild(opt); });
  body.appendChild(info); body.appendChild(toSel);
  openModal('Mover Técnico', body, 'Mover', ()=>{ const to = toSel.value; if(!to) return; const item = DATA[fromSup].splice(idx,1)[0]; if(!DATA[to]) DATA[to]=[]; DATA[to].push(item); const fromPath = DATA_NODE + '/' + encodeURIComponent(fromSup); const toPath = DATA_NODE + '/' + encodeURIComponent(to); db.ref(fromPath).set(DATA[fromSup]).then(()=> db.ref(toPath).set(DATA[to])); });
}

openMove.onclick = ()=>{ requireAdmin(()=> openMoveChooser()); };
function openMoveChooser(){
  const body = document.createElement('div');
  const desc = document.createElement('div'); desc.className='small-muted'; desc.textContent='Toque no técnico para selecionar (origem).';
  const listDiv = document.createElement('div'); listDiv.className='list-select'; listDiv.style.maxHeight='300px';
  Object.keys(DATA).forEach(s=>{ (DATA[s]||[]).forEach((t,i)=>{ const el=document.createElement('div'); el.className='list-item'; el.textContent = SUP_TITLES[s] + ' — ' + t.name; el.dataset.from = s; el.dataset.idx=i; el.onclick = ()=>{ modalBackdrop.style.display='none'; openMoveModal(el.dataset.from, parseInt(el.dataset.idx,10)); }; listDiv.appendChild(el); }); });
  body.appendChild(desc); body.appendChild(listDiv);
  openModal('Mover Técnico (selecione origem)', body, 'Fechar', ()=>{});
}

// Theme toggle and fullscreen
let lightMode = false;
themeBtn.addEventListener('click', ()=>{
  lightMode = !lightMode;
  if(lightMode){
    document.documentElement.style.setProperty('--bg','#f6f7fb');
    document.documentElement.style.setProperty('--card','#fff');
    document.documentElement.style.setProperty('--muted-2','#667085');
    document.documentElement.style.setProperty('--text','#0f172a');
    themeBtn.textContent = 'Tema escuro';
  } else {
    document.documentElement.style.setProperty('--bg','#0f172a');
    document.documentElement.style.setProperty('--card','#0b1220');
    document.documentElement.style.setProperty('--muted-2','#94a3b8');
    document.documentElement.style.setProperty('--text','#e6eef6');
    themeBtn.textContent = 'Tema claro';
  }
});

fullscreenBtn.addEventListener('click', ()=>{
  if(document.fullscreenElement){ document.exitFullscreen(); fullscreenBtn.textContent = 'Abrir App'; }
  else { document.documentElement.requestFullscreen().then(()=> fullscreenBtn.textContent = 'Sair App'); }
});

// Mark all visible active (admin)
function markAllVisibleActive(){
  Object.keys(DATA).forEach(s=>{
    if(currentFilter && currentFilter !== s) return;
    (DATA[s]||[]).forEach((t,idx)=>{ t.status='trabalha'; writeStatusToFirebase(s, idx, 'trabalha'); });
  });
}

// HISTORY and other helpers (omitted for brevity when seeding); assume same as previous file
function saveDayHistory(){ const date = dateInput.value || todayISO(); const monthKey = date.slice(0,7); const snap = JSON.parse(JSON.stringify(DATA)); db.ref(HISTORY_NODE + '/' + monthKey + '/' + date).set(snap).then(()=> alert('Histórico salvo para ' + date)).catch(err=> alert('Erro ao salvar histórico: ' + err.message)); }
function showMonthHistory(){ const monthKey = (dateInput.value || todayISO()).slice(0,7); db.ref(HISTORY_NODE + '/' + monthKey).once('value').then(snap => { const monthObj = snap.val() || {}; const body = document.createElement('div'); const title = document.createElement('div'); title.style.marginBottom='8px'; title.textContent = 'Histórico do mês: ' + monthKey; body.appendChild(title); const listDiv = document.createElement('div'); listDiv.className='list-select'; const dates = Object.keys(monthObj).sort(); if(dates.length===0) listDiv.textContent = 'Nenhum registro para este mês.'; dates.forEach(d => { const summary = monthObj[d]; let total=0, active=0; Object.keys(summary).forEach(s=> (summary[s]||[]).forEach(t=>{ total++; if(t.status && t.status!=='nao' && t.status!=='pendente') active++; })); const el = document.createElement('div'); el.className='list-item'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.textContent = d + ' — ' + active + '/' + total + ' ativos'; const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px'; const openBtn = document.createElement('button'); openBtn.className='ghost'; openBtn.textContent='Abrir'; openBtn.onclick = ()=> showDaySnapshotModal(d, summary); const exportBtn = document.createElement('button'); exportBtn.className='ghost'; exportBtn.textContent='Exportar CSV'; exportBtn.onclick = ()=> exportSnapshotCSV(d, summary); btns.appendChild(openBtn); btns.appendChild(exportBtn); el.appendChild(btns); listDiv.appendChild(el); }); body.appendChild(listDiv); openModal('Histórico do Mês', body, 'Fechar', ()=>{}); }); }

// wire history buttons (if present)
if(saveDayBtn) saveDayBtn.addEventListener('click', ()=>{ requireAdmin(()=> saveDayHistory()); });
if(viewMonthBtn) viewMonthBtn.addEventListener('click', ()=> showMonthHistory());

// quick expose for debug
window.__presenca = { read: ()=> DATA, markAllVisibleActive };

// initial render will be triggered by firebase listener
</script>
</body>
</html>
